<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Создание собственной модели User в Django</title>
    <link rel="canonical" href="https://ru.vahaah.guru//2013/05/14/sozdaniie-sobstviennoi-modieli-user-v-django.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://ru.vahaah.guru//2013/05/14/sozdaniie-sobstviennoi-modieli-user-v-django.html"
        },
        "headline": "Создание собственной модели User в Django",
        "image": {
          "@type": "ImageObject",
          "url": "https://ru.vahaah.guru.com/images/face.jpg",
          "height": 769,
          "width": 1024
        },
        "datePublished": "2013-05-14 12:11:00",
        "dateModified": "2013-05-14 12:11:00",
        "author": {
          "@type": "Person",
          "name": "Alex Vakhitov"
        },
        "publisher": {
          "@type": "Organization",
          "name": "ru.vahaah.guru",
          "logo": {
            "@type": "ImageObject",
            "url": "https://ru.vahaah.guru/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "",
        "keywords": [""]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">

      body { font-family: serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://ru.vahaah.guru//2013/05/14/sozdaniie-sobstviennoi-modieli-user-v-django.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="" class="photo"></amp-img>
      </p>
      <p><br>14 May 2013</p>
      <h1>Создание собственной модели User в Django</h1>
      <p>​С приходом <strong>django 1.5</strong> у нас наконецто появилась делать собственные модели <strong>User</strong>, сейчас я продемонстрирую вам как сделать простейшую модель.

Для начала давайте создадим наше приложение:</p>

<pre>python ../manage.py startapp accounts</pre>

<p>Теперь мы может отредактировать модель для нашего пользователя, открывает файл <strong>project.accounts.models</strong> для начала нам нужно добавить импорт нужных нам модулей, в данном случае хватит</p>

<pre>from django.db import models
from django.contrib.auth.models import BaseUserManager,AbstractBaseUser</pre>

<p>Теперь мы можем делать собствено модель пользователя</p>

<pre>class User(AbstractBaseUser):
    email = models.EmailField(
        verbose_name='Электропочта',
        max_length=255,
        unique=True,
        db_index=True,)
    username = models.CharField(verbose_name='Ник',  max_length=255, unique=True)
    avatar = models.ImageField(verbose_name='Аватар',  upload_to='images/%Y/%m/%d', blank=True, null=True)
    first_name = models.CharField(verbose_name='Имя',  max_length=255, blank=True)
    last_name = models.CharField(verbose_name='Фамилия',  max_length=255, blank=True)
    date_of_birth = models.DateField(verbose_name='День рождения',  blank=True, null=True)
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)</pre>

<p>Здесь нет ничего сложного все как обычно, теперь немного магии и выберем поле для входа на сайт и поля которые мы будем проверять, для этого добавим следующие строки</p>

<pre>    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['username']</pre>

<p>Теперь давайте создадим модель для администраторов, для этого над классом <strong>User</strong> создадим класс <strong>UserManager</strong></p>

<pre>class UserManager(BaseUserManager):
    def create_user(self, email, username, password=None):
        if not email:
            raise ValueError('Users must have an email address')

        user = self.model(
            email=UserManager.normalize_email(email),
            username=username,
            )

        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, username, password):
        user = self.create_user(email,
                                password=password,
                                username=username
        )
        user.is_admin = True
        user.save(using=self._db)
        return user</pre>

<p>И также в класс <strong>User</strong> нужно добавить следующую строку</p>

<pre>    objects = UserManager()</pre>

<p>Теперь давайте создадим функции в классе <strong>User</strong> которые облегчат нам жизнь</p>

<pre>    def get_full_name(self):
        return '%s %s' % (self.first_name, self.last_name,)

    def get_short_name(self):
        return self.username

    def __unicode__(self):
        return self.email

    def has_perm(self, perm, obj=None):
        return True

    def has_module_perms(self, app_label):
        return True

    @property
    def is_staff(self):
        return self.is_admin</pre>

<p>Собственно из названий функций сразу видно зачем они нужны</p>

<p>Полный вариант <strong>project.accounts.models</strong></p>

<pre># -*- coding: utf-8 -*-
from django.db import models
from django.contrib.auth.models import BaseUserManager, AbstractBaseUser


class UserManager(BaseUserManager):
    def create_user(self, email, username, password=None):
        if not email:
            raise ValueError('Users must have an email address')

        user = self.model(
            email=UserManager.normalize_email(email),
            username=username)

        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, username, password):
        user = self.create_user(email,
                                password=password,
                                username=username)
        user.is_admin = True
        user.save(using=self._db)
        return user


class User(AbstractBaseUser):
    email = models.EmailField(
        verbose_name='Электропочта',
        max_length=255,
        unique=True,
        db_index=True)
    username = models.CharField(verbose_name='Ник',  max_length=255, unique=True)
    avatar = models.ImageField(verbose_name='Аватар',  upload_to='images/%Y/%m/%d', blank=True, null=True)
    first_name = models.CharField(verbose_name='Имя',  max_length=255, blank=True)
    last_name = models.CharField(verbose_name='Фамилия',  max_length=255, blank=True)
    date_of_birth = models.DateField(verbose_name='День рождения',  blank=True, null=True)
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)

    objects = UserManager()

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['username']

    def get_full_name(self):
        return '%s %s' % (self.first_name, self.last_name,)

    def get_short_name(self):
        return self.username

    def __unicode__(self):
        return self.email

    def has_perm(self, perm, obj=None):
        return True

    def has_module_perms(self, app_label):
        return True

    @property
    def is_staff(self):
        return self.is_admin</pre>

<p>Давайте сразу создадим необходимые формы т.е редактируем файл <strong>project.account.forms</strong></p>

<pre># -*- coding: utf-8 -*-
from django import forms
from project.accounts.models import User
from django.contrib.auth.forms import ReadOnlyPasswordHashField


class UserCreationForm(forms.ModelForm):
    password1 = forms.CharField(label='Password', widget=forms.PasswordInput)
    password2 = forms.CharField(label='Password confirmation', widget=forms.PasswordInput)

    class Meta:
        model = User
        fields = ('email', 'username')

    def clean_password2(self):
        password1 = self.cleaned_data.get("password1")
        password2 = self.cleaned_data.get("password2")
        if password1 and password2 and password1 != password2:
            raise forms.ValidationError("Passwords don't match")
        return password2

    def save(self, commit=True):
        user = super(UserCreationForm, self).save(commit=False)
        user.set_password(self.cleaned_data["password1"])
        if commit:
            user.save()
        return user


class UserChangeForm(forms.ModelForm):
    password = ReadOnlyPasswordHashField()

    class Meta:
        model = User

    def clean_password(self):
        return self.initial["password"]</pre>

<p>Теперь приступим к редактированию<strong> project.accounts.admin</strong> и наполним его следующим содержимым</p>

<pre># -*- coding: utf-8 -*-
from django.contrib import admin
from django.contrib.auth.models import Group
from django.contrib.auth.admin import UserAdmin

from project.accounts.models import User
from project.accounts.forms import UserChangeForm, UserCreationForm


class UserAdmin(UserAdmin):
    form = UserChangeForm
    add_form = UserCreationForm


    list_display = ('email', 'username', 'is_admin',)
    list_filter = ('is_admin',)
    fieldsets = (
        (None, {'fields': ('email', 'username', 'password')}),
        ('Personal info', {'fields': ('date_of_birth', 'first_name', 'last_name', 'avatar')}),
        ('Permissions', {'fields': ('is_admin',)}),
        ('Important dates', {'fields': ('last_login',)}),
    )
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'date_of_birth', 'password1', 'password2')}
        ),
    )
    search_fields = ('email',)
    ordering = ('email',)
    filter_horizontal = ()

admin.site.register(User, UserAdmin)
admin.site.unregister(Group)</pre>

<p>Теперь осталась маленькая деталька, это добавление нашей модели в <strong>settings.py</strong></p>

<pre>AUTH_USER_MODEL = 'accounts.User'</pre>

<p>Вот теперь поздравляю Вас с созданием собственной модели пользователя сайта</p>

    </article>
  </body>
</html>
