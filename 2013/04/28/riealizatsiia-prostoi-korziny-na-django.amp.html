<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Реализация простой корзины на Django</title>
    <link rel="canonical" href="https://ru.vahaah.guru//2013/04/28/riealizatsiia-prostoi-korziny-na-django.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://ru.vahaah.guru//2013/04/28/riealizatsiia-prostoi-korziny-na-django.html"
        },
        "headline": "Реализация простой корзины на Django",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1200x1200.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2013-04-28 12:01:00",
        "dateModified": "2013-04-28 12:01:00",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "ru.vahaah.guru",
          "logo": {
            "@type": "ImageObject",
            "url": "https://ru.vahaah.guru/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "",
        "keywords": [""]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">

      body { font-family: serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://ru.vahaah.guru//2013/04/28/riealizatsiia-prostoi-korziny-na-django.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="" class="photo"></amp-img>
      </p>
      <p><br>28 April 2013</p>
      <h1>Реализация простой корзины на Django</h1>
      <p>В последнии дни очень много людей спрашивали, как сделать корзину на Django сайте и вот я решил написать реализацию простейшей корзины для сайта.

В первую очередь нам нужно описать модель нашей корзины</p>

<pre>#models.py
from django.db import models
from catalog.models import Product

class CartItem(models.Model):
    cart_id = models.CharField(max_length=50)
    date_added = models.DateTimeField(auto_now_add=True)
    quantity = models.IntegerField(default=1)
    product = models.ForeignKey(Product, unique=False)

    class Meta:
        ordering = ['date_added']

    def total(self):
        return self.quantity * self.product.price

    def name(self):
        return self.product.name

    def price(self):
        return self.product.price

    def augment_quantity(self, quantity):
         self.quantity = self.quantity + int(quantity)
         self.save()</pre>

<p>Как мне кажется здесь все просто, корзина связана с нашим продуктом (Product) и все действия понятны и дополнительного описания не требуется.</p>

<p>Теперь давайте опишем логику работы корзины, для это в папке с приложением создадим файл файл cart.py</p>

<pre>#cart.py
import decimal
import random
from django.shortcuts import get_object_or_404
from cart.models import CartItem
from catalog.models import Product

CART_ID_SESSION_KEY = 'cart_id'


def _cart_id(request):
    if request.session.get(CART_ID_SESSION_KEY,'') == '':
        request.session[CART_ID_SESSION_KEY] = _generate_cart_id()
    return request.session[CART_ID_SESSION_KEY]


def _generate_cart_id():
    cart_id = ''
    characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890!@#$%^&amp;amp;*() '
    cart_id_length = 50
    for y in range(cart_id_length):
        cart_id += characters[random.randint(0, len(characters)-1)]
    return cart_id


def get_cart_items(request):
    return CartItem.objects.filter(cart_id=_cart_id(request))


def add_to_cart(request):
    postdata = request.POST.copy()
    product_slug = postdata.get('product_slug', '')
    quantity = postdata.get('quantity', 1)
    p = get_object_or_404(Product, slug=product_slug)
    cart_products = get_cart_items(request)
    product_in_cart = False
    for cart_item in cart_products:
        if cart_item.product.id == p.id:
            cart_item.augment_quantity(quantity)
            product_in_cart = True
    if not product_in_cart:
        ci = CartItem()
        ci.product = p
        ci.quantity = quantity
        ci.cart_id = _cart_id(request)
        ci.save()


def cart_distinct_item_count(request):
    return get_cart_items(request).count()


def get_single_item(request, item_id):
    return get_object_or_404(CartItem, id=item_id, cart_id=_cart_id(request))


def update_cart(request):
    postdata = request.POST.copy()
    item_id = postdata['item_id']
    quantity = postdata['quantity']
    cart_item = get_single_item(request, item_id)
    if cart_item:
        if int(quantity) &amp;gt; 0:
            cart_item.quantity = int(quantity)
            cart_item.save()
        else:
            remove_from_cart(request)


def remove_from_cart(request):
    postdata = request.POST.copy()
    item_id = postdata['item_id']
    cart_item = get_single_item(request, item_id)
    if cart_item:
        cart_item.delete()


def cart_subtotal(request):
    cart_total = decimal.Decimal('0.00')
    cart_products = get_cart_items(request)
    for cart_item in cart_products:
        cart_total += cart_item.product.price * cart_item.quantity
    return cart_total


def is_empty(request):
    return cart_distinct_item_count(request) == 0


def empty_cart(request):
    user_cart = get_cart_items(request)
    user_cart.delete()</pre>

<p>Здесь тоже все понятно и все описанно в названии функций, теперь сделаем форму для корзины</p>

<pre>#forms.py
from django import forms
class ProductAddToCartForm(forms.Form):
	quantity = forms.IntegerField(widget=forms.TextInput(attrs={'size':'2',
		'value':'1', 'class':'input-small', 'maxlength':'5'}),
		error_messages={'invalid':'Введите правильное количество'}, min_value=1, label='Количество')
	product_slug = forms.CharField(widget=forms.HiddenInput())
	def __init__(self, request=None, *args, **kwargs):
		self.request = request
		super(ProductAddToCartForm, self).__init__(*args, **kwargs)
	def clean(self):
		if self.request:
			if not self.request.session.test_cookie_worked():
				raise forms.ValidationError("Cookies должны быть включены")
		return self.cleaned_data</pre>

<p>И представление</p>

<pre>from django.shortcuts import render_to_response
from django.template import RequestContext
from django.http import HttpResponseRedirect

from cart import cart

def show_cart(request, template_name="cart/cart.html"):
    if request.method == 'POST':
        postdata = request.POST.copy()
        if postdata['submit'] == 'Remove':
            cart.remove_from_cart(request)
        if postdata['submit'] == 'Update':
            cart.update_cart(request)
    cart_items = cart.get_cart_items(request)
    page_title = 'Корзина'
    cart_subtotal = cart.cart_subtotal(request)
    return render_to_response(template_name, locals(), context_instance=RequestContext(request))</pre>

<p>Ну и urls.py для полной картины</p>

<pre>    urlpatterns = patterns('cart.views',
	url(r'^$', 'show_cart', { 'template_name': 'cart/cart.html'}, 'show_cart'),
	)</pre>

<p>Думаю шаблон описывать не стоит, так как все делается также как и для любых других представлений.</p>

<p>Даже если вы просто скопипастите данные скрипты у вас будет полностью рабочая корзины и вчитавшись в код вы сможете ее модернизировать под свои нужды</p>

    </article>
  </body>
</html>
